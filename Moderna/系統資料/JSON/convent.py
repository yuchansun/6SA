import json
import unicodedata
import re

# 康熙字典部首對應 CJK 字元的對應表
kangxi_to_cjk_map = {
  "⺁": "厂",
  "⺂": "乛",
  "⺃": "乚",
  "⺄": "乙",
  "⺅": "亻",
  "⺆": "冂",
  "⺇": "𠘨",
  "⺈": "刀",
  "⺉": "刂",
  "⺊": "卜",
  "⺋": "㔾",
  "⺌": "小",
  "⺍": "小",
  "⺎": "兀",
  "⺏": "尣",
  "⺐": "尢",
  "⺑": "𡯂",
  "⺒": "巳",
  "⺓": "幺",
  "⺔": "彑",
  "⺕": "彐",
  "⺖": "忄",
  "⺗": "心",
  "⺘": "扌",
  "⺙": "攵",
  "⺛": "旡",
  "⺜": "日",
  "⺝": "月",
  "⺞": "歺",
  "⺟": "母",
  "⺠": "民",
  "⺡": "氵",
  "⺢": "氺",
  "⺣": "灬",
  "⺤": "爫",
  "⺥": "爫",
  "⺦": "丬",
  "⺧": "牛",
  "⺨": "犭",
  "⺩": "王",
  "⺪": "𤴔",
  "⺫": "目",
  "⺬": "示",
  "⺭": "礻",
  "⺮": "𥫗",
  "⺯": "糹",
  "⺰": "纟",
  "⺱": "罓",
  "⺲": "罒",
  "⺳": "㓁",
  "⺴": "冗",
  "⺵": "𦉫",
  "⺶": "羊",
  "⺷": "𦍌",
  "⺸": "𦍋",
  "⺹": "耂",
  "⺺": "肀",
  "⺻": "聿",
  "⺼": "肉",
  "⺽": "𦥑",
  "⺾": "艹",
  "⺿": "艹",
  "⻀": "艹",
  "⻁": "虎",
  "⻂": "衤",
  "⻃": "覀",
  "⻄": "西",
  "⻅": "见",
  "⻆": "角",
  "⻇": "𧢲",
  "⻈": "讠",
  "⻉": "贝",
  "⻊": "𧾷",
  "⻋": "车",
  "⻌": "辶",
  "⻍": "辶",
  "⻎": "辶",
  "⻏": "邑",
  "⻐": "钅",
  "⻑": "長",
  "⻒": "镸",
  "⻓": "长",
  "⻔": "门",
  "⻕": "𨸏",
  "⻖": "阝",
  "⻗": "雨",
  "⻘": "青",
  "⻙": "韦",
  "⻚": "页",
  "⻛": "风",
  "⻜": "飞",
  "⻝": "食",
  "⻞": "𩙿",
  "⻟": "飠",
  "⻠": "饣",
  "⻡": "𩠐",
  "⻢": "马",
  "⻣": "骨",
  "⻤": "鬼",
  "⻥": "鱼",
  "⻦": "鸟",
  "⻧": "卤",
  "⻨": "麦",
  "⻩": "黄",
  "⻪": "黾",
  "⻫": "斉",
  "⻬": "齐",
  "⻭": "歯",
  "⻮": "齿",
  "⻯": "竜",
  "⻰": "龙",
  "⻱": "龜",
  "⻲": "亀",
  "⻳": "龟",
  "⼀": "一",
  "⼁": "丨",
  "⼂": "丶",
  "⼃": "丿",
  "⼄": "乙",
  "⼅": "亅",
  "⼆": "二",
  "⼇": "亠",
  "⼈": "人",
  "⼉": "儿",
  "⼊": "入",
  "⼋": "八",
  "⼌": "冂",
  "⼍": "冖",
  "⼎": "冫",
  "⼏": "几",
  "⼐": "凵",
  "⼑": "刀",
  "⼒": "力",
  "⼓": "勹",
  "⼔": "匕",
  "⼕": "匚",
  "⼖": "匸",
  "⼗": "十",
  "⼘": "卜",
  "⼙": "卩",
  "⼚": "厂",
  "⼛": "厶",
  "⼜": "又",
  "⼝": "口",
  "⼞": "囗",
  "⼟": "土",
  "⼠": "士",
  "⼡": "夂",
  "⼢": "夊",
  "⼣": "夕",
  "⼤": "大",
  "⼥": "女",
  "⼦": "子",
  "⼧": "宀",
  "⼨": "寸",
  "⼩": "小",
  "⼪": "尢",
  "⼫": "尸",
  "⼬": "屮",
  "⼭": "山",
  "⼮": "巛",
  "⼯": "工",
  "⼰": "己",
  "⼱": "巾",
  "⼲": "干",
  "⼳": "幺",
  "⼴": "广",
  "⼵": "廴",
  "⼶": "廾",
  "⼷": "弋",
  "⼸": "弓",
  "⼹": "彐",
  "⼺": "彡",
  "⼻": "彳",
  "⼼": "心",
  "⼽": "戈",
  "⼾": "戶",
  "⼿": "手",
  "⽀": "支",
  "⽁": "攴",
  "⽂": "文",
  "⽃": "斗",
  "⽄": "斤",
  "⽅": "方",
  "⽆": "无",
  "⽇": "日",
  "⽈": "曰",
  "⽉": "月",
  "⽊": "木",
  "⽋": "欠",
  "⽌": "止",
  "⽍": "歹",
  "⽎": "殳",
  "⽏": "毋",
  "⽐": "比",
  "⽑": "毛",
  "⽒": "氏",
  "⽓": "气",
  "⽔": "水",
  "⽕": "火",
  "⽖": "爪",
  "⽗": "父",
  "⽘": "爻",
  "⽙": "爿",
  "⽚": "片",
  "⽛": "牙",
  "⽜": "牛",
  "⽝": "犬",
  "⽞": "玄",
  "⽟": "玉",
  "⽠": "瓜",
  "⽡": "瓦",
  "⽢": "甘",
  "⽣": "生",
  "⽤": "用",
  "⽥": "田",
  "⽦": "疋",
  "⽧": "疒",
  "⽨": "癶",
  "⽩": "白",
  "⽪": "皮",
  "⽫": "皿",
  "⽬": "目",
  "⽭": "矛",
  "⽮": "矢",
  "⽯": "石",
  "⽰": "示",
  "⽱": "禸",
  "⽲": "禾",
  "⽳": "穴",
  "⽴": "立",
  "⽵": "竹",
  "⽶": "米",
  "⽷": "糸",
  "⽸": "缶",
  "⽹": "网",
  "⽺": "羊",
  "⽻": "羽",
  "⽼": "老",
  "⽽": "而",
  "⽾": "耒",
  "⽿": "耳",
  "⾀": "聿",
  "⾁": "肉",
  "⾂": "臣",
  "⾃": "自",
  "⾄": "至",
  "⾅": "臼",
  "⾆": "舌",
  "⾇": "舛",
  "⾈": "舟",
  "⾉": "艮",
  "⾊": "色",
  "⾋": "艸",
  "⾌": "虍",
  "⾍": "虫",
  "⾎": "血",
  "⾏": "行",
  "⾐": "衣",
  "⾑": "襾",
  "⾒": "見",
  "⾓": "角",
  "⾔": "言",
  "⾕": "谷",
  "⾖": "豆",
  "⾗": "豕",
  "⾘": "豸",
  "⾙": "貝",
  "⾚": "赤",
  "⾛": "走",
  "⾜": "足",
  "⾝": "身",
  "⾞": "車",
  "⾟": "辛",
  "⾠": "辰",
  "⾡": "辵",
  "⾢": "邑",
  "⾣": "酉",
  "⾤": "釆",
  "⾥": "里",
  "⾦": "金",
  "⾧": "長",
  "⾨": "門",
  "⾩": "阜",
  "⾪": "隶",
  "⾫": "隹",
  "⾬": "雨",
  "⾭": "靑",
  "⾮": "非",
  "⾯": "面",
  "⾰": "革",
  "⾱": "韋",
  "⾲": "韭",
  "⾳": "音",
  "⾴": "頁",
  "⾵": "風",
  "⾶": "飛",
  "⾷": "食",
  "⾸": "首",
  "⾹": "香",
  "⾺": "馬",
  "⾻": "骨",
  "⾼": "高",
  "⾽": "髟",
  "⾾": "鬥",
  "⾿": "鬯",
  "⿀": "鬲",
  "⿁": "鬼",
  "⿂": "魚",
  "⿃": "鳥",
  "⿄": "鹵",
  "⿅": "鹿",
  "⿆": "麥",
  "⿇": "麻",
  "⿈": "黃",
  "⿉": "黍",
  "⿊": "黑",
  "⿋": "黹",
  "⿌": "黽",
  "⿍": "鼎",
  "⿎": "鼓",
  "⿏": "鼠",
  "⿐": "鼻",
  "⿑": "齊",
  "⿒": "齒",
  "⿓": "龍",
  "⿔": "龜",
  "⿕": "龠",
  "㇆": "𠃌",
  "㇏": "乀",
  "㇐": "一",
  "㇑": "丨",
  "㇒": "丿",
  "㇓": "丿",
  "㇔": "丶",
  "㇕": "𠃍",
  "㇖": "乛",
  "㇗": "𠃊",
  "㇘": "𠃎",
  "㇙": "𠄌",
  "㇚": "亅",
  "㇛": "𡿨",
  "㇜": "𠃋",
  "㇝": "乀",
  "㇞": "𠃑",
  "㇟": "乚",
  "㇠": "乙",
  "㇡": "𠄎"
}

# 替換康熙字典部首為 CJK 字元
def replace_kangxi_with_cjk(text):
    return ''.join(kangxi_to_cjk_map.get(char, char) for char in text)

# 讀取原始資料檔案
def read_input_file(file_path):
    with open(file_path, "r", encoding="utf-8") as f:
        return json.load(f)

# 文字正規化函數
def normalize_text(value):
    return unicodedata.normalize('NFC', value)

# 判斷是否為CJK字元
def is_cjk_char(char):
    return '\u4E00' <= char <= '\u9FFF'

# 替換非CJK字符
def replace_non_cjk(value):
    return ''.join(char if is_cjk_char(char) else '\u5DE5' if char == '\u2F2F' else char for char in value)

# 轉換函數
def transform_data(input_data):
    output = []

    for table_key in input_data.keys():
        if table_key.startswith("Table "):
            for entry in input_data[table_key]:
                # 替換特殊 Unicode 字元並正規化文字
                for key, value in entry.items():
                    if isinstance(value, str):
                        unicode_replacements = {
                            "\u2f74": "\u7acb",
                            "\u2f24": "\u5927",
                            "\u2f2d": "\u5c71",
                            "\u2fbc": "\u9ad8",
                            "\u2fa8": "\u9580",
                            "\u2fa6": "\u91d1",
                            "\u2f42": "\u6587",
                            "\u2ed1": "\u9577",
                            "\u2f5e": "\u7384",
                            "\u2fba": "\u99ac"
                        }
                        for old_char, new_char in unicode_replacements.items():
                            value = value.replace(old_char, new_char)
                        value = normalize_text(value)
                        value = replace_non_cjk(value)
                        value = replace_kangxi_with_cjk(value)
                        entry[key] = value

                # 將考試項目包裝成列表格式
                exam_items = [entry["考試項目"]]

                transformed_entry = {
                    "區域別": entry.get("區域別"),
                    "立別": entry.get("立別"),
                    "學校": entry["學校名稱"],
                    "系所": entry["招生學系"],
                    "計畫類別": entry.get("計畫類別", "特殊選才"),
                    "招生對象": entry.get("招生對象").replace(",", ",") if entry.get("招生對象") else None,
                    "招生名額": entry["招生名額"],
                    "考試項目": exam_items,
                    "日程公告": {
                        "簡章公告": entry["簡章公告"],
                        "報名開始日期": entry["報名起始日期"],
                        "報名結束日期": entry["報名結束日期"],
                        "考試開始日期": entry["考試起始日期"],
                        "考試結束日期": entry["考試結束日期"],
                        "放榜日期": entry["放榜日期"]
                    },
                    "聯絡人": entry.get("聯絡人"),
                    "聯絡電話": entry.get("聯絡電話"),
                    "報考須知": entry.get("報考須知")
                }

                output.append(transformed_entry)

    return output

# 主執行流程
def main(input_file, output_file):
    input_data = read_input_file(input_file)
    output_data = transform_data(input_data)

    with open(output_file, "w", encoding="utf-8") as f:
        json.dump(output_data, f, ensure_ascii=False, indent=4)

    print(f"轉換完成，結果已儲存至 {output_file}")

# 設定檔案路徑
input_file_path = "106.json"
output_file_path = "output.json"

# 執行主程式
if __name__ == "__main__":
    main(input_file_path, output_file_path)
